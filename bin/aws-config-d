#!/usr/bin/env bash
set -euo pipefail

VERBOSE=false
args=()
for arg in "$@"; do
    case "$arg" in
        -v|--verbose) VERBOSE=true ;;
        *) args+=("$arg") ;;
    esac
done
set -- "${args[@]+${args[@]}}"

_verbose() { [ "$VERBOSE" = true ] && echo "aws: [verbose] $*" >&2 || true; }

CONFIG=~/.aws/config
CONFIG_D=~/.aws/config.d
HASH_FILE="$CONFIG_D/.config.sha256"
SOURCES_HASH_FILE="$CONFIG_D/.sources.sha256"

_hash() { { sha256sum "$1" 2>/dev/null || shasum -a 256 "$1"; } | cut -d' ' -f1; }
_hash_string() { printf '%s' "$1" | { sha256sum 2>/dev/null || shasum -a 256; } | cut -d' ' -f1; }

_sources() {
    # List enabled config files: skip dotfiles, *.off, *.example, and directories
    for f in "$CONFIG_D"/*; do
        [ -f "$f" ] || continue
        case "$(basename "$f")" in
            .*|*.off|*.example) continue ;;
        esac
        echo "$f"
    done
}

_disabled() {
    # List disabled config files: *.off in config.d/ + files in disabled/ and off/
    for f in "$CONFIG_D"/*.off; do
        [ -f "$f" ] || continue
        echo "$f"
    done
    for dir in "$CONFIG_D"/disabled "$CONFIG_D"/off; do
        [ -d "$dir" ] || continue
        for f in "$dir"/*; do
            [ -f "$f" ] || continue
            case "$(basename "$f")" in
                .*|README) continue ;;
            esac
            echo "$f"
        done
    done
}

_list() {
    echo "enabled:"
    local found=false
    for f in $(_sources); do
        local name
        name=$(basename "$f")
        [ "$name" = "00-defaults" ] && continue
        echo "  $name"
        found=true
    done
    if [ "$found" = false ]; then
        echo "  (none)"
    fi

    echo ""
    echo "disabled:"
    local disabled_found=false
    for f in $(_disabled); do
        local name rel
        rel=${f#"$CONFIG_D/"}
        echo "  $rel"
        disabled_found=true
    done
    if [ "$disabled_found" = false ]; then
        echo "  (none)"
    fi
}

_enable() {
    local name="$1"

    # Check disabled/ dir first, then off/ dir, then .off suffix
    if [ -f "$CONFIG_D/disabled/$name" ]; then
        mv "$CONFIG_D/disabled/$name" "$CONFIG_D/$name"
        echo "enabled: $name"
    elif [ -f "$CONFIG_D/off/$name" ]; then
        mv "$CONFIG_D/off/$name" "$CONFIG_D/$name"
        echo "enabled: $name"
    elif [ -f "$CONFIG_D/${name}.off" ]; then
        mv "$CONFIG_D/${name}.off" "$CONFIG_D/$name"
        echo "enabled: $name"
    elif [ -f "$CONFIG_D/$name" ]; then
        echo "already enabled: $name" >&2
        return 0
    else
        echo "not found: $name" >&2
        return 1
    fi
}

_disable() {
    local name="$1"

    if [ ! -f "$CONFIG_D/$name" ]; then
        # Check if already disabled
        if [ -f "$CONFIG_D/disabled/$name" ] || [ -f "$CONFIG_D/off/$name" ] || [ -f "$CONFIG_D/${name}.off" ]; then
            echo "already disabled: $name" >&2
            return 0
        fi
        echo "not found: $name" >&2
        return 1
    fi

    if [ "$name" = "00-defaults" ]; then
        echo "cannot disable 00-defaults" >&2
        return 1
    fi

    mkdir -p "$CONFIG_D/disabled"
    mv "$CONFIG_D/$name" "$CONFIG_D/disabled/$name"
    echo "disabled: $name (moved to disabled/)"
}

_rm() {
    local name="$1"

    if [ "$name" = "00-defaults" ]; then
        echo "cannot remove 00-defaults" >&2
        return 1
    fi

    local found=false

    # Check enabled location
    if [ -f "$CONFIG_D/$name" ]; then
        rm "$CONFIG_D/$name"
        found=true
    fi

    # Check disabled locations
    for f in "$CONFIG_D/disabled/$name" "$CONFIG_D/off/$name" "$CONFIG_D/${name}.off"; do
        if [ -f "$f" ]; then
            rm "$f"
            found=true
        fi
    done

    if [ "$found" = true ]; then
        echo "removed: $name"
    else
        echo "not found: $name" >&2
        return 1
    fi
}

_rebuild() {
    local sources
    sources=$(_sources)
    if [ -z "$sources" ]; then
        echo "aws: no enabled config files in $CONFIG_D" >&2
        return 1
    fi
    # shellcheck disable=SC2086
    cat $sources > "$CONFIG"
    _hash "$CONFIG" > "$HASH_FILE"
    _hash_string "$sources" > "$SOURCES_HASH_FILE"
    echo "aws: rebuilt $CONFIG from config.d/"
}

_check_drift() {
    if [ -f "$CONFIG" ] && [ -f "$HASH_FILE" ]; then
        local current expected
        current=$(_hash "$CONFIG")
        expected=$(cat "$HASH_FILE")
        if [ "$current" != "$expected" ]; then
            echo "aws: WARNING — $CONFIG was modified outside of config.d/"
            echo "aws: possibly by 'aws configure sso' or manual editing."
            echo "aws: reconcile changes into $CONFIG_D/ then run:"
            echo "aws:   aws-config-d force"
            return 1
        fi
    fi
    return 0
}

_help() {
    echo "Usage: aws-config-d [-v] <command>"
    echo ""
    echo "Options:"
    echo "  -v, --verbose    Show what auto is checking and why it skips"
    echo ""
    echo "Commands:"
    echo "  auto             Check for changes and rebuild if needed"
    echo "  force            Rebuild unconditionally, resetting the drift hash"
    echo "  ls, list         List enabled and disabled profile collections"
    echo "  enable <name>    Enable a disabled profile collection"
    echo "  disable <name>   Disable a profile collection (moves to disabled/)"
    echo "  rm <name>        Permanently delete a profile collection"
    echo "  help             Show this help"
}

case "${1:-help}" in
    auto)
        # Called from shell hooks — only rebuild if sources are newer
        if [ ! -d "$CONFIG_D" ]; then
            _verbose "config.d/ does not exist at $CONFIG_D — skipping"
            exit 0
        fi
        if [ ! -f "$CONFIG" ]; then
            _verbose "no config at $CONFIG — building for the first time"
            _rebuild
            exit 0
        fi
        needs_rebuild=false
        sources=$(_sources)
        # Check if the set of enabled sources changed since last build
        current_sources_hash=$(_hash_string "$sources")
        if [ -f "$SOURCES_HASH_FILE" ]; then
            expected_sources_hash=$(cat "$SOURCES_HASH_FILE")
            if [ "$current_sources_hash" != "$expected_sources_hash" ]; then
                _verbose "enabled sources changed — rebuild needed"
                needs_rebuild=true
            fi
        else
            _verbose "no sources hash on record — rebuild needed"
            needs_rebuild=true
        fi
        # Also check mtimes for content changes within the same set of files
        if [ "$needs_rebuild" = false ]; then
            for f in $sources; do
                if [ "$f" -nt "$CONFIG" ]; then
                    _verbose "$(basename "$f") is newer than config — rebuild needed"
                    needs_rebuild=true
                    break
                fi
            done
        fi
        if [ "$needs_rebuild" = false ]; then
            _verbose "sources unchanged and all older than config — nothing to do"
        else
            if _check_drift; then
                _rebuild
            else
                _verbose "drift detected — skipping rebuild (reconcile and force)"
            fi
        fi
        ;;
    force|-f|--force)
        if [ ! -d "$CONFIG_D" ]; then
            echo "aws: $CONFIG_D does not exist" >&2
            exit 1
        fi
        _rebuild
        ;;
    ls|list)
        _list
        ;;
    enable)
        if [ -z "${2:-}" ]; then
            echo "Usage: aws-config-d enable <name>" >&2
            exit 1
        fi
        _enable "$2"
        _rebuild
        ;;
    disable)
        if [ -z "${2:-}" ]; then
            echo "Usage: aws-config-d disable <name>" >&2
            exit 1
        fi
        _disable "$2"
        _rebuild
        ;;
    rm|remove)
        if [ -z "${2:-}" ]; then
            echo "Usage: aws-config-d rm <name>" >&2
            exit 1
        fi
        _rm "$2"
        _rebuild
        ;;
    help|-h|--help)
        _help
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo ""
        _help >&2
        exit 1
        ;;
esac
